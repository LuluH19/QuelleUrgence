name: CI

on:
  push:
    branches:
      - main
      - dev
    paths:
      - 'client/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches:
      - main
      - dev
    paths:
      - 'client/**'

env: {}

concurrency:
  group: ci-client-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ========================================
  # Quality: Commit Linting (Conventional Commits)
  # ========================================
  lint-commits:
    name: Lint Commits
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install commitlint
        run: |
          npm install --save-dev @commitlint/cli @commitlint/config-conventional

      - name: Validate commits with commitlint
        uses: wagoid/commitlint-github-action@v6
        with:
          configFile: '.commitlintrc.json'

  # ========================================
  # Quality: Linting
  # ========================================
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: 'client/package-lock.json'

      - name: Install dependencies
        working-directory: ./client
        run: npm ci

      - name: Run ESLint
        working-directory: ./client
        run: npm run lint

      - name: Comment PR with lint result
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Linting client r√©ussi'
            });

  # ========================================
  # Quality: TypeScript Type Check
  # ========================================
  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: 'client/package-lock.json'

      - name: Install dependencies
        working-directory: ./client
        run: npm ci

      - name: Run TypeScript type checker
        working-directory: ./client
        run: npm run typecheck

      - name: Comment PR with typecheck result
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: ' V√©rification des types r√©ussie'
            });

  # ========================================
  # Security: NPM Audit
  # ========================================
  security-scan-npm:
    name: NPM Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: 'client/package-lock.json'

      - name: Install dependencies
        working-directory: ./client
        run: npm ci

      - name: Run npm audit
        working-directory: ./client
        run: |
          echo "üîç Scanning for vulnerabilities..."
          npm audit --audit-level=high --json > audit-report.json 2>&1 || true
          
          node -e "
            try {
              const report = require('./audit-report.json');
              const vulnerabilities = report.metadata.vulnerabilities;
              
              console.log(' Rapport npm audit:');
              console.log('  Total: ' + (vulnerabilities.total || 0));
              console.log('  Critical: ' + (vulnerabilities.critical || 0));
              console.log('  High: ' + (vulnerabilities.high || 0));
              console.log('  Medium: ' + (vulnerabilities.moderate || 0));
              console.log('  Low: ' + (vulnerabilities.low || 0));
              
              // V√©rifier si les vuln√©rabilit√©s HIGH sont uniquement dans les devDependencies
              const fs = require('fs');
              const pkg = JSON.parse(fs.readFileSync('./package.json', 'utf8'));
              const prodDeps = new Set(Object.keys(pkg.dependencies || {}));
              let highInProduction = false;
              
              if (vulnerabilities.high > 0 && report.vulnerabilities) {
                for (const [pkgName, vuln] of Object.entries(report.vulnerabilities)) {
                  if (vuln.severity === 'high' && vuln.isDirect) {
                    // V√©rifier si c'est une d√©pendance directe de production
                    if (prodDeps.has(pkgName)) {
                      highInProduction = true;
                      break;
                    }
                  }
                }
              }
              
              if (vulnerabilities.critical > 0) {
                console.log('');
                console.log('‚ùå Vuln√©rabilit√©s CRITICAL d√©tect√©es - Blocage du pipeline');
                process.exit(1);
              } else if (vulnerabilities.high > 0 && highInProduction) {
                console.log('');
                console.log('‚ö†Ô∏è  Vuln√©rabilit√©s HIGH d√©tect√©es dans les d√©pendances de production');
                console.log('‚ùå Blocage du pipeline');
                process.exit(1);
              } else if (vulnerabilities.high > 0) {
                console.log('');
                console.log('‚ö†Ô∏è  Vuln√©rabilit√©s HIGH d√©tect√©es dans les devDependencies uniquement');
                console.log('‚ÑπÔ∏è  Ces vuln√©rabilit√©s n\'affectent pas la production');
                console.log('‚úÖ Pipeline autoris√© √† continuer');
              } else {
                console.log('');
                console.log('‚úÖ Pas de vuln√©rabilit√©s CRITICAL ou HIGH');
              }
            } catch (e) {
              console.log('  Impossible de parser le rapport npm audit');
              console.log('  Erreur: ' + e.message);
              process.exit(1);
            }
          "

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-client
          path: client/audit-report.json
          retention-days: 30

  # ========================================
  # Build: Vite Build
  # ========================================
  build:
    name: Build Application
    needs: [lint, typecheck, security-scan-npm]
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: 'client/package-lock.json'

      - name: Install dependencies
        working-directory: ./client
        run: npm ci

      - name: Build application
        working-directory: ./client
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-client
          path: client/dist/
          retention-days: 30

      - name: Comment PR with build result
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: ' Build client r√©ussi'
            });

  # ========================================
  # Status Check
  # ========================================
  ci-status:
    name: CI Client Status
    runs-on: ubuntu-latest
    needs: [lint-commits, lint, typecheck, security-scan-npm, build]
    if: always()

    steps:
      - name: Check CI status
        run: |
          FAILED=0
          if [ "${{ needs.lint-commits.result }}" != "success" ] && [ "${{ needs.lint-commits.result }}" != "skipped" ]; then
            echo "‚ùå Lint commits √©chou√©"
            FAILED=1
          fi
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "‚ùå Lint code √©chou√©"
            FAILED=1
          fi
          if [ "${{ needs.typecheck.result }}" != "success" ]; then
            echo "‚ùå Typecheck √©chou√©"
            FAILED=1
          fi
          if [ "${{ needs.security-scan-npm.result }}" != "success" ]; then
            echo "‚ùå Security scan √©chou√©"
            FAILED=1
          fi
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "‚ùå Build √©chou√©"
            FAILED=1
          fi
          if [ $FAILED -eq 1 ]; then
            echo "‚ùå Pipeline CI Client √©chou√©e"
            exit 1
          fi
          echo "‚úÖ Pipeline CI Client r√©ussie"